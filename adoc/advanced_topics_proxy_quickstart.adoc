[[advanced.topics.proxy.quickstart]]
= {productname} {productnumber} Proxy
include::entities.adoc[]


This chapter explains how to install and set up {productname} {productnumber} Proxy.
It also provides notes about migrating a previous proxy to version 3.2.

[[at.manager.proxy.concepts]]
== Overview

{productname} {productnumber} Proxy is a {productname} add-on that caches software packages on an internal, central server.
The proxy caches patch updates from {suse} or custom RPMs generated by third-party organizations.
A proxy allows you to use bandwidth more effectively because client systems connect to the proxy for updates, and the {productname} server is no longer required to handle all client requests.
The proxy also supports transparent custom package deployment.

{productname} Proxy is an open source (GPLv2) solution that provides the following features:

* Cache software packages within a Squid proxy.
* Client systems see the {susemgrproxy} as a {productname} server instance.
* The {susemgrproxy} is registered as a client system with the {productname} server.

The primary goal of a {susemgrproxy} is to improve {productname} performance by reducing bandwidth requirements and accelerating response time.



[[at.manager.proxy.inst-and-clients]]
== Proxy Installation and Connecting Clients



[[at.manager.proxy.requirements]]
=== Requirements

The following section provides {susemgrproxy} requirements.

.Supported Client Systems
For supported clients and their requirements, see <<quickstart.sect.prereq.clientos>>.
// Supported Client Systems

.Hardware Requirements
Hardware requirements highly depend on your usage scenario.
When planning proxy environments, consider the amount of data you want to cache on your proxy.
If your proxy should be a 1:1 mirror of your {productname}, the same amount of disk space is required.
For specific hardware requirements, see the following table.

[cols="1,1", options="header"]
|===
| Hardware | Required
| CPU             | Multi-core 64-bit CPU (x86_64).
| RAM             | Minimum 4{nbsp}GB for a non-production server
|                 | Minimum 16{nbsp}GB for a production server
| Free Disk Space | Minimum 100{nbsp}GB for base installation and at least 50 GB for caching per SUSE product and +100 GB per Red Hat product; a resizeable partition strongly recommended.
|===

[TIP]
.Storage for Proxy Data
====
{suse} recommends storing the squid proxy caching data on a separate disk formatted with the XFS file system.
====

.SSL Certificate Password
For installing the proxy, you need the SSL certificate password entered during the initial installation of {productname}.

.Network Requirements
For additional network requirements, see <<quickstart.sect.prereq.network>>.

.{scc}
For using {susemgrproxy}, you need an account at {scc} (SCC) where your purchased products and product subscriptions are registered.
Make sure you have the following subscriptions:

* One or more subscriptions for {susemgrproxy}.
* One or more subscriptions for {productname}.
* Subscriptions for the products on the client systems you want to register with {productname} via {susemgrproxy} .
* Subscriptions to client entitlements for the client system you want to register with {productname} via {susemgrproxy} .

.Network Time Protocol (NTP)
The connection to the Web server via Secure Sockets Layer (SSL) requires correct time settings on the server, proxy and clients.
For this reason, all systems must use NTP.
For more information, see https://www.suse.com/documentation/sles-12/book_sle_admin/data/cha_netz_xntp.html.

.Virtual Environments
The following virtual environments are supported:

* http://www.linux-kvm.org/page/Main_Page
* http://www.vmware.com/
* http://www.microsoft.com/en-us/server-cloud/solutions/virtualization.aspx

For running {susemgrproxy}
in virtual environments, use the following settings for the virtual machine (VM):

* At least 1 GB of RAM
* Bridged network



[[at.manager.proxy.inst]]
=== Installation and Setup

The following section will guide you through the installation and setup procedure.

{productname} Proxy systems are registered as traditional clients or as Salt clients using a bootstrap script.
Migrating a traditionally registered Proxy system to a Salt Proxy system is not possible.
Re-install the Proxy if you want to switch to Salt.
A {susemgrproxy} can serve both Traditional and Salt clients.

[IMPORTANT]
.Downloading Channels
====
Before you can select the correct child channels while creating the activation key, ensure you have completely downloaded the channels for {sle} 12 SP4.
====


[[at.manager.proxy.install.prep]]
.Procedure: Registering the Proxy


. Create an activation key based on the {sle} 12 SP4 base channel.
For more information about activation keys, see <<create.act.keys>>.
+

.Proxy Activation Key
image::proxy-key.png[]

. From the [guimenu]``Child Channels`` listing select the {productname} {productnumber} Proxy child channel with the matching update channel ([systemitem]``SUSE Manager Proxy-3.2-Pool`` and [systemitem]``SUSE-Manager-Proxy-3.2-Updates``).
These child channels are required for providing the proxy packages and updates.
For normal SLES clients, [systemitem]``SLES12-SP4-Updates`` plus [systemitem]``SLE-Manager-Tools12-Pool`` and [systemitem]``SLE-Manager-Tools12-Updates`` are mandatory.
+

.Base and Child Proxy Channel
image::sles12-proxy-child.png[]


. Modify a bootstrap script for the proxy if needed.
If you want to run the proxy on a traditional client (system type ``Management``) uncheck [guimenu]``Bootstrap using Salt``.
Using Salt is supported since version 3.2.
// What's up with:
// Enable Remote Configuration
// Enable Remote Commands
For more information about bootstrap scripts, see <<modify.bootstrap.script>>.
+

.Modifying Bootstrap Script
image::sles12-proxy-bootstrap.png[]

. Create the SUSE Manager Tools Repository for bootstrapping, see <<create.tools.repository>>.
. Bootstrap the client with the bootstrap script.  For more information, see <<connect.first.client>>.
. In case of a Salt client, accept the key on the menu:Main Menu[Salt > Keys] page by clicking the check mark and it will appear in the menu:Main Menu[Systems > Overview].
. Check via menu:System Details[Software > Software Channels] that the two proxy channels [systemitem]``SUSE Manager Proxy-3.2-Pool`` and [systemitem]``SUSE-Manager-Proxy-3.2-Updates`` are selected.

.Proxy Channels
image::sles12-proxy-channels.png[]

A few more steps are still needed:

* Install the [path]``patterns-suma_proxy`` pattern (see <<at.manager.proxy.run.pattern>>)
* Copy the SSL certificate and key from the server (see <<at.manager.proxy.run.copycert>>)
* Run [command]``configure-proxy.sh`` (see <<at.manager.proxy.run.confproxy>>)

You will then be able to register your clients against the proxy using the {webui} or a bootstrap script as if it were a {productname} server.
For more information, see <<at.manager.proxy.register.saltclients>>.



[[at.manager.proxy.run.pattern]]
=== Install the [path]``suma_proxy`` pattern

On the server select the [package]``pattern_suma_proxy`` package for installation, or make sure the [path]``suma_proxy`` pattern is installed using the following command on the proxy as root:

----
zypper in -t pattern suma_proxy
----

The new salt-broker service will be automatically started at the end of the package installation.
This service forwards the Salt interactions to the {productname} server.

[NOTE]
.Proxy Chains
====
It is possible to arrange Salt proxies in a chain.
In such a case, the upstream proxy is named "`parent`".
====

Make sure the proxie's TCP ports `4505` and `4506` are open and that the proxy can reach the {productname} server (or another upstream proxy) on these ports.



[[at.manager.proxy.run.copycert]]
=== Copy Server Certificate and Key

The proxy will share some SSL information with the {productname} server, so the next step is to copy the certificate and its key from the {productname} server or the upstream proxy.

As root, enter the following commands on the proxy using your {productname} server or chained proxy named [replaceable]``PARENT``:

----
mkdir /root/ssl-build
cd /root/ssl-build
scp root@PARENT:/root/ssl-build/RHN-ORG-PRIVATE-SSL-KEY .
scp root@PARENT:/root/ssl-build/RHN-ORG-TRUSTED-SSL-CERT .
scp root@PARENT:/root/ssl-build/rhn-ca-openssl.cnf .
----


[NOTE]
.Known Limitation
====
The {susemgrproxy} functionality is only supported if the SSL certificate was signed by the same CA as the {productname} Server certificate.
Using certificates signed by different CAs for Proxies and Server is not supported.
====



[[at.manager.proxy.run.confproxy]]
=== Running [command]``configure-proxy.sh``

The [command]``configure-proxy.sh`` script will finalize the setup of your {susemgrproxy}.

Now execute the interactive [command]``configure-proxy.sh`` script.
Pressing kbd:[Enter] without further input will make the script use the default values provided between brackets ``[]``.
Here is some information about the requested settings:

{productname} Parent::
A {productname} parent can be either another proxy server or a {productname} server.

HTTP Proxy::
A HTTP proxy enables your {productname} proxy to access the Web.
This is needed if direct access to the Web is prohibited by a firewall.

Proxy Version to Activate::
Normally, the correct value (3.0, 3.1, or 3.2) should be offered as a default.

Traceback Email::
An email address where to report problems.

Use SSL::
For safety reasons, press ``Y``.

Do You Want to Import Existing Certificates?::
Answer ``N``.
This ensures using the new certificates that were copied previously from the {productname} server.

Organization::
The next questions are about the characteristics to use for the SSL certificate of the proxy.
The organization might be the same organization that was used on the server, unless of course your proxy is not in the same organization as your main server.

Organization Unit::
The default value here is the proxy's hostname.

City::
Further information attached to the proxy's certificate.
Beware the country code must be made of two upper case letters.
For further information on country codes, refer to the online https://www.iso.org/obp/ui/#search[list of alpha-2 codes].
+

[TIP]
.Country Code
====
As the country code enter the country code set during the SUSE Manager installation.
For example, if your proxy is in US and your {productname} in DE, you must enter `DE` for the proxy.
====
+

Cname Aliases (Separated by Space)::
Use this if your proxy server can be accessed through various DNS CNAME aliases.
Otherwise it can be left empty.

CA Password::
Enter the password that was used for the certificate of your {productname} server.

Do You Want to Use an Existing SSH Key for Proxying SSH-Push Salt Minions?::
Use this option if you want to reuse a SSH key that was used for SSH-Push Salt minions on the server.

Create and Populate Configuration Channel rhn_proxy_config_1000010001?::
Accept default ``Y``.

SUSE Manager Username::
Use same user name and password as on the {productname} server.

Activate advertising proxy via SLP?::
SLP stands for Service Location Protocol.

If parts are missing, such as CA key and public certificate, the script prints commands that you must execute to integrate the needed files.
When the mandatory files are copied, re-run [command]``configure-proxy.sh``.
Also restart the script if a HTTP error was met during script execution.

[command]``configure-proxy.sh`` activates services required by {productname} Proxy, such as [systemitem]``squid``, [systemitem]``apache2``, [systemitem]``salt-broker``, and [systemitem]``jabberd``.

To check the status of the proxy system and its clients, click the proxy system's details page on the {webui} (menu:Main Menu[Systems > Proxy], then the system name). [guimenu]``Connection`` and [guimenu]``Proxy`` subtabs display the respective status information.



[[at.manager.proxy.register.saltclients]]
=== Registering Salt Clients via {susemgrproxy}

Proxy servers may now act as a broker and package cache for Salt minions.
These minions can be registered with a bootstrap script like the traditional clients, or from the {webui}, or the command line.

Registering Salt clients via {susemgrproxy} from the {webui}
is done almost the same way as registering clients directly with the {productname} server.
The difference is that you specify the name of the proxy in the [guimenu]``Proxy`` drop-box on the menu:Main Menu[Systems > Bootstrapping] page.

.Bootstrapping a Salt Client With a Proxy
image::proxy-saltbootstrap.png[scaledwidth=80%]

.Procedure: Register a Salt client through a proxy from command line
. Instead of the {webui}, you may use the command line to register a minion through a proxy.
To do so, add the proxy FQDN as the master in the minions configuration file located at:
+

----
/etc/salt/minion
----
+

or alternatively:
+

----
/etc/salt/minion.d/NAME.conf
----

. Add the FQDN to the minion file:
+

----
master: proxy123.example.com
----
+

Save and restart the salt-minion service with:
+

----
systemctl restart salt-minion
----

. On the Server, accept the new minion key with:
+

----
salt-key -a 'minion'
----
+

The minion will now connect to the proxy exclusively for Salt operations and normal HTTP package downloads.



[[at.manager.proxy.register.clients]]
=== Registering Clients via {susemgrproxy} with a Script

Registering clients (either traditional or Salt) via {susemgrproxy} with a script is done almost the same way as registering clients directly with the {productname} server.
The difference is that you create the bootstrap script on the {susemgrproxy} with a command-line tool.
The bootstrap script then deploys all necessary information to the clients.
The bootstrap script refers some parameters (such as activation keys or GPG keys) that depend on your specific setup.


. Create a client activation key on the {productname} server using the {webui}.
See <<create.act.keys>>.
. On the proxy, execute the [command]``mgr-bootstrap`` command-line tool as {rootuser}.
If needed, use the additional command-line switches to tune your bootstrap script. An important option is [command]``--traditional`` that enables to opt for a traditional client instead of a salt minion.
+
To view available options type [command]``mgr-bootstrap --help`` from the command line:
+

----
# mgr-bootstrap --activation-keys=key-string
----

. Optionally edit the resulting bootstrap script.
Execute the bootstrap script on the clients as described in <<connect.first.client>>.


The clients are registered with the {susemgrproxy} specified in the bootstrap script.



[[at.additional.info.about.client.registration.on.proxies]]
=== Additional Information about Client Registration on Proxies

Within the {webui}, standard proxy pages will show information about client, no matter whether minions or traditional clients.

// FIXME: adoc refinement needed
A list of clients connected to a proxy can be located under menu:Systems[] <proxy name> menu:Details[]menu:Proxy[].

// FIXME: adoc refinement needed
A list of chained proxies for a minion can be located under menu:Systems[] <minion name> menu:Details[]menu:Connection[]

If you decide to move any of your clients between proxies or the server you will need to repeat the registration process from scratch.



[[advanced.topics.proxy.pxe]]
== Enabling PXE Boot via {susemgrproxy}



[[advanced.topics.proxy.pxe.sync]]
=== Synchronizing Profiles and System Information

To enable PXE boot via a proxy server, additional software must be installed and configured on both the {productname} server and the {susemgrproxy} server.

. On the {productname} server install [package]#susemanager-tftpsync# :
+

----
zypper in susemanager-tftpsync
----

. On the {susemgrproxy} server install [package]#susemanager-tftpsync-recv# :
+

----
zypper in susemanager-tftpsync-recv
----

. Run the [command]``configure-tftpsync.sh`` setup script and enter the requested information:
+

----
configure-tftpsync.sh
----
+

It asks for hostname and IP address of the {productname} server and of the proxy itself.
Additionally, it asks for the tftpboot directory on the proxy.

. On the {productname} server, run [command]``configure-tftpsync.sh`` to configure the upload to the {susemgrproxy} server:
+

----
configure-tftpsync.sh FQDN_of_Proxy_Server
----

. To initiate an initial synchronization on the SUSE Manager Server run:
+

----
cobbler sync
----
+

Also can also be done after each a change within Cobbler that needs to be synchronized immediately.
Otherwise Cobbler synchronization will also run automatically when needed.
For more information about Cobbler, see <<advanced.topics.cobbler>>.



[[advanced.topics.proxy.pxe.dhcp]]
=== Configuring DHCP for PXE via {susemgrproxy}

{productname} is using Cobbler to provide provisioning.
PXE (tftp) is installed and activated by default.
To enable systems to find the PXE boot on the {susemgrproxy} server add the following to the DHCP configuration for the zone containing the systems to be provisioned:

----
next-server: <IP_Address_of_SUSE_Manager_Proxy_Server>
filename: "pxelinux.0"
----



[[advanced.topics.proxy.migration3]]
== Migrating {productname} 3.1 Proxy to Version {productnumber} [Management]

The recommended order for migrations is to first migrate the server and then the proxies.
// Note that a {productname} 3 Proxy works correctly with {productname} 3.1.

For the migration of traditionally managed proxies there are two possible approaches:

* Existing {productname} proxies may be upgraded to version 3.2 with {yast} or [command]``zypper`` migration.
* Alternatively, the proxies may be replaced by new ones.

This section documents both approaches.

[NOTE]
.Migrating {productname} 3 Proxy and Earlier
====
For migrating {productname} 3 Proxy and earlier, see https://www.suse.com/documentation/suse-manager-3/book_suma_advanced_topics_31/data/sect1_chapter_book_suma_advanced_topics_31.html, Chapter "SUSE Manager 3.1 Proxy".
====


[[at.replacing.a.susemgrproxy]]
=== Replacing a {susemgrproxy}

A {susemgrproxy} is `dumb` in the sense that it does not contain any information about the clients which are connected to it.
A {susemgrproxy} can therefore be replaced by a new one.
Naturally, the replacement proxy must have the same name and IP address as its predecessor.

In order to replace a {susemgrproxy} and keeping the clients registered to the proxy leave the old proxy in {productname}.
Create a reactivation key for this system and then register the new proxy using the reactivation key.
If you do not use the reactivation key, you will need to re-registered all the clients against the new proxy.

[[proc.advanced.topics.proxy.migration3.replace]]
.Procedure: Replacing a {susemgrproxy} and Keeping the Clients Registered
. Before starting the actual migration procedure, save the data from the old proxy, if needed.
Consider copying important data to a central place that can also be accessed by the new server:
** Copy the scripts that are still needed.
** Copy the activation keys from the previous server.
Of course, it is always better to re-create the keys.
. Shutdown the server.
. Install a new {productname} {productnumber} Proxy, see <<at.manager.proxy.inst-and-clients>>.
. In the {productname} {webui} select the newly installed {susemgrproxy} and delete it from the systems list.
[[step.at.proxy.migration3.replace.react]]
. In the {webui}, create a reactivation key for the old proxy system: On the System Details tab of the old proxy click [guimenu]``Reactivation``.
Then click [guimenu]``Generate New Key``, and remember it (write it on a piece of paper or copy it to the clipboard).
For more information about reactivation keys, see <<s5-sm-system-details-react>>.
. After the installation of the new proxy, perform the following actions (if needed):
** Copy the centrally saved data to the new proxy system.
** Install any other needed software.
** If the proxy is also used for autoinstallation, do not forget to setup TFTP synchronization.

[IMPORTANT]
.Proxy Installation and Client Connections
====
During the installation of the proxy, clients will not be able to reach the {productname} server.
After a {susemgrproxy} system has been deleted from the systems list, all clients connected to this proxy will be (incorrectly) listed as `directly connected` to the {productname} server.
After the first successful operation on a client _such as execution of a remote command or installation of a package or patch_ this information will automatically be corrected.
This may take a few hours.
====



[[at.upgrade.a.susemgrproxy]]
=== Upgrading a {susemgrproxy} from 3.1 to {productnumber}

In most situations upgrading the proxy will be your preferred solution as this retains all cached packages.
Selecting this route saves time especially regarding proxies connected to {productname} server via low-bandwith links.
This upgrade is similar to a standard client migration.

[WARNING]
.Synchronizing Target Channels
====
Before successfully initializing the product migration, you first must make sure that the migration target channels are completely mirrored.
To upgrade to {productname} 3.2 Proxy, you will require at least the [systemitem]``SUSE Linux Enterprise Server 12 SP4`` base channel with the [systemitem]``SUSE Manager Proxy 3.2`` child channel for your architecture.
====

.Procedure: Migrating Proxy to {productnumber}
. Direct your browser to the {productname} {webui} where your proxy is registered, and login.
. On the menu:Main Menu[Systems > Systems > Proxy] page select your proxy server from the table.
+

image::suma_proxy_old_details_page.png[]

. On the system's detail page select the menu:Software[SP Migration] tab.
+

image::suma_proxy_old_details_spmigration.png[]

. From this page you will see installed products listed on your proxy client, and the available target products.
Select the required [guimenu]``Target Products``.  In this case, you will require [systemitem]``SUSE Linux Enterprise Server 12 SP4`` with [systemitem]``SUSE Manager Proxy 3.2``.
+

image::suma_proxy_migration_target.png[]
+

. Then confirm with btn:[Select Channels].
+
image::suma_proxy_migration_channels.png[]

. From the [guimenu]``Schedule Migration`` menu, select the time and click btn:[Confirm].
+
image::suma_proxy_migration_schedule.png[]

Check the [guimenu]``System Status`` on the menu:System Details[Overview] when the migration is done.

image::suma_proxy_migrated.png[]

Finally consider scheduling a reboot.
