= Configure the Storage Server
include::entities.adoc[]

[#setup-the-iscsi-storage-server]
== Create the iSCSI Block Devices on the Storage Server

In this procedure you will setup the iSCSI block devices on the storage server.

[#procedure-setup-the-storage-server]
.Procedure: Configure the iSCSI Block Devices on the Storage Server

. Once the storage server has been prepared as explained in: xref:ha-requirements.adoc#prepare-the-shared-storage-node[Prepare the iSCSI Storage Node], open a terminal as *{ruser}* and prepare the following image files for use as the block device files:
+

. Prepare the following block device files:
+

----
dd if=/dev/zero of=c01-sbd.img bs=1M seek=100 count=0 <1>

dd if=/dev/zero of=c01-spacewalk.img bs=1M seek=102400 count=0 <2>

dd if=/dev/zero of=c01-srv.img bs=1M seek=10240 count=0 <3>

dd if=/dev/zero of=c01-pgsql.img bs=1M seek=51200 count=0 <4>

dd if=/dev/zero of=c01-cacherhn.img bs=1M seek=26200 count=0 <5>

dd if=/dev/zero of=c01-others.img bs=1M seek=52200 count=0 <6>
----
<1> *c01-sbd.img* SBD storage device 100{nbsp}MB
<2> *c01-spacewalk.img* /var/spacewalk 100{nbsp}GB (A production setup will be greater than 500{nbsp}GB+)
<3> *c01-srv.img* /srv 10{nbsp}GB
<4> *c01-pgsql.img* /var/lib/pgsql 50{nbsp}GB
<5> *c01-cacherhn.img* /var/cache 25{nbsp}GB
<6> *c01-others.img* other 100{nbsp}GB for all other required file systems


[#setup-the-block-device-images-using-yast]
== Setup the Block Device Files with {yast}


.Procedure: Setup the Block Devices

. Run {yast} to setup the new block device images on the storage server:
+

----
yast2 iscsi-lio-server
----
+

. From the *Service* screen press kbd:[alt+shift+B] to start the service kbd:[(x) When Booting].
+

image::step2-iscsi-lio-service-on-boot.png[Service on Boot Screen]

. Proceed to the *Global* screen by pressing (kbd:[alt+shift+G]). Then press kbd:[alt+shift+o] to select kbd:[(x) No Discovery Authentication]
+

image::step3-lio-target-auth.png[No Authentication Screen]

. Proceed to the *Target* screen by pressing (kbd:[alt+shift+T]).
+

image::step4-lio-targets.png[LIO Targets Screen]

. Press (kbd:[alt+shift+A]) to add a new iSCSI Target.

. On the *Add iSCSI Target* screen press kdb:[alt+shift+U] to uncheck kbd:[x Use Login Authentication].

. Make a note of the IP address listed here, you will use it later to connect the clients.

. Add each of the block devices created previously with the *dd* command *(LUNS)*. Press kbd:[alt+shift+A] to open the *LUN* screen. Add each of the LUNS with kbd:[alt+shift+B]. Add them in the same the order as shown in the screenshot.
+

image::step5-assign-luns.png[Assign LUNS]

. Select next to continue kbd:[alt+shift+N].
+

image::step6-modify-initiators-acls.png[Modify Initiators Screen]

. Add the initiator names for both {susemgr} nodes by pressing kbd:[alt+shift+A], then enter the initiator name. You will need to do this for each node:
+

image::step7-add-initiators-names.png[Add Initiator Names]

. Your initiator should look similar to the following:
+

image::step8-added-initiators.png[Added Initiators]

. Select *Next* to continue (kbd:[alt+shift+N]).

. Select *Finish* to continue (kbd:[alt+shift+F]).

. This concludes setup of the storage server. Continue to the next procedure to connect both {susemgr} clients to the storage server.

==  Client Configuration

In the last procedure you configured the storage server LUNS. You will now connect the two {susemgr} clients to the iSCSI server storage.

[#final-iscsi-configuration-clients]
.Procedure: Finalizing iSCSI Configuration on the clients

. On both {susemgr} nodes run:
+
----
yast iscsi-client
----

. Select the *Connected Targets* tab by pressing kbd:[alt+n].

. Add a new target by pressing kbd:[alt+shift+a].

. Press kbd:[alt+shift+i] to add the IP address noted earlier. Select *No Discovery Authentication*.
+

image::step9-initiator-discovery.png[Initiator Discovery]

. Select *Next* to continue.

. *Connect* the clients to the iSCSI by pressing kbd:[alt+shift+O]. Press kbd:[alt+shift+S] to change startup from manual to automatic.
+

image::step10-connect-clients.png[Connect Clients]

. Select *Next* to continue (kbd:[alt+shift+n]).

. Select *Next* to continue (kbd:[alt+shift+n]).

. Select *Ok* to continue (kbd:[alt+shift+o]).

. Check that the iSCSI disks are visible from the clients, and preview disk sizes:
+

----
node1@linux-zqtb:~> lsscsi -vs
[0:0:0:0]    cd/dvd  QEMU     QEMU DVD-ROM     2.5+  /dev/sr0        -
  dir: /sys/bus/scsi/devices/0:0:0:0  [/sys/devices/pci0000:00/0000:00:01.1/ata1/host0/target0:0:0/0:0:0:0]
[2:0:0:0]    disk    LIO-ORG  FILEIO           4.0   /dev/sda    104MB
  dir: /sys/bus/scsi/devices/2:0:0:0  [/sys/devices/platform/host2/session1/target2:0:0/2:0:0:0]
[2:0:0:1]    disk    LIO-ORG  FILEIO           4.0   /dev/sdf    107GB
  dir: /sys/bus/scsi/devices/2:0:0:1  [/sys/devices/platform/host2/session1/target2:0:0/2:0:0:1]
[2:0:0:2]    disk    LIO-ORG  FILEIO           4.0   /dev/sde   53.6GB
  dir: /sys/bus/scsi/devices/2:0:0:2  [/sys/devices/platform/host2/session1/target2:0:0/2:0:0:2]
[2:0:0:3]    disk    LIO-ORG  FILEIO           4.0   /dev/sdd   27.4GB
  dir: /sys/bus/scsi/devices/2:0:0:3  [/sys/devices/platform/host2/session1/target2:0:0/2:0:0:3]
[2:0:0:4]    disk    LIO-ORG  FILEIO           4.0   /dev/sdc   10.7GB
  dir: /sys/bus/scsi/devices/2:0:0:4  [/sys/devices/platform/host2/session1/target2:0:0/2:0:0:4]
[2:0:0:5]    disk    LIO-ORG  FILEIO           4.0   /dev/sdb   54.7GB
  dir: /sys/bus/scsi/devices/2:0:0:5  [/sys/devices/platform/host2/session1/target2:0:0/2:0:0:5]
----

This concludes iSCSI setup.


