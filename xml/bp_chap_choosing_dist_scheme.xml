<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook50-profile.xsl"
                 type="text/xml" 
                 title="Profiling step"?>
<!DOCTYPE chapter
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="suma.choosing.dist.scheme">
 <title>Managing Your Subscriptions</title>
 <para>
  There are two methods for managing your subscriptions. Both methods
  access &scc; and provide specialized benefits.
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Directly connecting to &scc; is the recommended default way of managing
    your &susemgr; server.
   </para>
  </listitem>
  <listitem>
   <para>
    If you have special network security requirements which do not allow
    access from your internal network to the internet then you can use
    &sls; 12 running the &rmtool; (RMT) or &smtool; (SMT).  These tools
    will contact &scc; from a system connected to the external network
    and obtain updates for your clients which you may then mount on your
    internal &susemgr; server. This is the preferred method for managing
    client systems within a highly secure network infrastructure.
   </para>
  </listitem>
 </itemizedlist>
 <sect1 xml:id="scc">
  <title>&scc; (SCC)</title>

  <para>
   &scc; (SCC) is the central place to manage your purchased &suse;
   subscriptions, helping you access your update channels and get in
   contact with &suse; experts. The user-friendly interface gives you a
   centralized view of all your &suse; subscriptions, allowing you to
   easily find all subscription information you need. The improved
   registration provides faster access to your patches and
   updates. &scc; is also designed to provide a common platform for your
   support requests and feedback. Discover a new way of managing your
   &suse; account and subscriptions via one interface—anytime,
   anywhere. For more information on using &scc;, see <link
   xlink:href="https://scc.suse.com/docs/userguide"/>.
  </para>
 </sect1>
 <sect1 xml:id="disconnect-setup">
  <title>Disconnected Setup with RMT or SMT (DMZ)</title>

  <para>
   If it is not possible to connect &susemgr; directly or via a proxy to
   the Internet, a disconnected setup in combination with RMT or SMT is
   the recommended solution.  In this scenario, RMT or SMT stays in an
   <quote>external</quote> network with a connection to &scc; and
   synchronizes the software channels and repositories on a removable
   storage medium. Then you separate the storage medium from RMT or SMT,
   and mount it locally on your &susemgr; server to read the updated
   data.
  </para>

  <formalpara>
   <title>RMT</title>
   <para>
    The successor of SMT and currently runs on the following systems:
   </para>
  </formalpara>
  <itemizedlist>
   <listitem>
    <para>&sle; 15 (when available), 12 SP2, and 12 SP3</para>
   </listitem>
   <listitem>
    <para>openSUSE Leap 42.2, Leap 42.3, and openSUSE Tumbleweed</para>
   </listitem>
  </itemizedlist>
   <para>
    RMT allows you to provision updates for all of your devices running
    a product based on &sle; 12 SPx and later as well as openSUSE Leap.
   </para>

  <formalpara>
   <title>SMT</title>
   <para>
    The predecessor of RMT and is no longer actively developed.  It runs on
    &sls; 12 SPx and allows you to provision updates for products based
    on &sle; 12 SPx and earlier.  You will still need it, if you want to
    update &sle; 11 clients.
   </para>
  </formalpara>
  
  <sect2 xml:id="rmtool">
   <title>&rmtool; (RMT) and Disconnected Setup (DMZ)</title>
   <para>
    The following procedure will guide you through using RMT.  It will
    work best with a dedicated RMT instance per &susemgr;.
   </para>
   <para>
    For more information, see <link
    xlink:href="https://github.com/SUSE/rmt#offline-mode"/>.
   </para>
   <procedure>
    <title>RMT: Fetching Repository Data from &scc;</title>
    <step>
     <para>
      Configure RMT in the external network with SCC. For details about
      configuring RMT with &sle; 12 SP3 or version 15 (when available),
      see <link
      xlink:href="https://github.com/SUSE/rmt#installation-and-configuration"
      />.
     </para>
    </step>
    <step>
     <para>
      Using RMT, mirror all required repositories.
     </para>
    </step>
    <step>
     <para>
      Get the required JSON responses from SCC and save them as files at
      the specified path (for example, <filename>/mnt/usb</filename>):
     </para>
<screen>&prompt.root;rmt-cli export data /mnt/usb</screen>
    </step>
    <step>
     <para>
      Export settings about repositories to mirror to the specified path
      (in this case, <filename>/mnt/usb</filename>); this command will
      create a <filename>repos.json</filename> file there:
     </para>
     <screen>&prompt.root;rmt-cli export settings /mnt/usb</screen>
     <para>
      Check <filename>repos.json</filename> and edit it to remove the
      repositories you do not need.
     </para>
    </step>
    <step xml:id="pro.rmtool.export.repos">
     <para>
      Mirror the repositories according to the settings in the
      <filename>repos.json</filename> file to the specified path (in
      this case, <filename>/mnt/usb</filename>).
     </para>
     <important>
      <title>Write Permissions for RMT User</title>
      <para>
       The directory being written to must be writeable for the same
       user as the rmt service. The rmt user setting is defined in the
       <literal>cli</literal> section of
       <filename>/etc/rmt.conf</filename>.
      </para>
     </important>
     <para>
      Enter:
     </para>
     <screen>&prompt.root;rmt-cli export repos /mnt/usb</screen>
    </step>
    <step>
     <para>
      Unmount the storage medium and carry it securely to your &susemgr;
      server.
     </para>
    </step>
   </procedure>
   <para>
    On the &susemgr; server, continue with <xref
    linkend="disconnect.mgr.update-repos"/>.
   </para>
  </sect2>
  
  <sect2 xml:id="sub.mgr.tool">
   <title>&smtool; (SMT) and Disconnected Setup (DMZ)</title>
   <para>
    The following procedure will guide you through using SMT.
   </para>

  <procedure>
   <title>SMT: Fetching Repository Data from &scc;</title>
   <step>
    <para>
     Configure SMT in the external network with SCC. For details about
     configuring SMT with &sle; 12, see <link
     xlink:href="https://www.suse.com/documentation/sles-12/book_smt/data/book_smt.html"
     />.
    </para>
   </step>
   <step>
    <para>
     Using SMT, mirror all required repositories.
    </para>
   </step>
   <step>
    <para>
     Create a <quote>database replacement file</quote> (for example,
     <filename>/tmp/dbrepl.xml</filename>.
    </para>
<screen>&prompt.root;smt-sync --createdbreplacementfile /tmp/dbrepl.xml</screen>
   </step>
   <step xml:id="pro.mgr.tool.mount.storage">
    <para>
     Mount a removable storage medium such as an external hard disk or USB
     flash drive.
    </para>
   </step>
   <step>
    <para>
     Export the data to the mounted medium:
    </para>
<screen>smt-sync --todir /media/disk/
smt-mirror --dbreplfile /tmp/dbrepl.xml --directory /media/disk \
           --fromlocalsmt -L /var/log/smt/smt-mirror-export.log</screen>
    <important>
     <title>Write Permissions for SMT User</title>
     <para>
      The directory being written to must be writeable for the same user as
      the smt daemon (user=smt). The smt user setting is defined in
      <filename>/etc/smt.conf</filename>. You can check if the correct user is
      specified via the following command:
     </para>
<screen>&prompt.root;egrep '^smtUser' /etc/smt.conf</screen>
    </important>
    <note>
     <title>Keeping the Disconnected Server Up-to-date</title>
     <para>
      <command>smt-sync</command> also exports your subscription
      data. To keep &susemgr; up-to-date with your subscriptions,
      you must frequently import and export this data.
     </para>
    </note>
   </step>
   <step>
    <para>
     Unmount the storage medium and carry it securely to your &susemgr;
     server.
    </para>
   </step>
  </procedure>
   <para>
    On the &susemgr; server, continue with <xref
    linkend="disconnect.mgr.update-repos"/>.
   </para>
  </sect2>
  
  <sect2 xml:id="disconnect.mgr.update-repos">
   <title>Updating Repositories on &susemgr; From Storage Media</title>
   
  <para>
   <remark>Will this work the same way with media created on
   RMT?</remark> This procedure will show you how to update the
   repositories on the &susemgr; server from the storage media.
  </para>

  <procedure>
   <title>Updating the &susemgr; Server from the Storage Medium</title>
   <step>
    <para>
     Mount the storage medium on your &susemgr; server (for example, at
     <filename>/media/disk</filename>).
    </para>
   </step>
   <step>
    <para>
     Specify the local path on the &susemgr; server in
     <literal>/etc/rhn/rhn.conf</literal>:
    </para>
<screen>server.susemanager.fromdir = /media/disk</screen>
    <para>
     This setting is mandatory for &scc; and <command>mgr-sync</command>.
    </para>
   </step>
   <step>
    <para>
     Restart Tomcat:
    </para>
<!-- bsc#977196 -->
<!-- <screen>rctomcat6 restart</screen> -->
<screen>systemctl restart tomcat</screen>
   </step>
   <step xml:id="pro.mgr.tool.sync">
    <para>
     Before performing another operation on the server execute a full sync:
    </para>
<screen>mgr-sync refresh   # SCC (fromdir in rhn.conf required!)</screen>
   </step>
   <step>
    <para>
     <command>mgr-sync</command> can now be executed normally:
    </para>
<screen>mgr-sync list channels
mgr-sync add channel channel-label</screen>
    <warning>
     <title>Data Corruption</title>
     <para>
      The disk must always be available at the same mount point. To avoid data
      corruption, do not trigger a sync, if the storage medium is not mounted.
      If you have already added a channel from a local repository path, you
      will not be able to change its URL to point to a different path
      afterwards.
     </para>
    </warning>
   </step>
  </procedure>

  <para>
   Up-to-date data is now available on your &susemgr; server and is ready for
   updating client systems. According to your maintenance windows or update
   schedule refresh the data on the storage medium with RMT or SMT.
  </para>
  </sect2>
  <sect2>
   <title>Refreshing Data on the Storage Medium</title>
  <procedure>
   <title>Refreshing Data on the Storage Medium from RMT or SMT</title>
   <step>
    <para>
     On your &susemgr; server, unmount the storage medium and carry it to your
     RMT or SMT.
    </para>
   </step>
   <step>
    <para>
     On your RMT or SMT system, continue with the synchronization step
     (either <xref linkend="pro.rmtool.export.repos"/> or <xref
     linkend="pro.mgr.tool.sync"/>).
    </para>
    <warning>
     <title>Data Corruption</title>
     <para>
      The storage medium must always be available at the same mount point. To
      avoid data corruption, do not trigger a sync if the storage medium is not
      mounted.
     </para>
    </warning>
   </step>
  </procedure>

  <para>
   This concludes using RMT or SMT with &susemgr;.
  </para>
 </sect2>
</sect1>
</chapter>
